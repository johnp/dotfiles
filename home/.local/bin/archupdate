#!/bin/zsh
# archupdate: A tmux+zsh wrapper around _archupdate.
#   As the shell `_archupdate` runs in could be killed, e.g. by an X server crash, this script wraps
#   it inside a temporary tmux session, duplicates the command output into a log file which it uses to
#   reprint the output after the temporary tmux session closed itself and clear(1)ed the screen.

# Documentation:
#   `--color always`: force color support, because isatty(1) returns false in tmux command mode
#   `>&1`/`2>&2`: duplicate stdout/stderr (requires zsh multi_os)
#   `&>`: interleave stdout+stderr into the log file (same)

tmpfile=$(mktemp /tmp/archupdate_log.XXX)
tmux new -A -s archupdate -n archupdate '_archupdate >&1 2>&2 &> "${tmpfile}"' \; set status off
cat "${tmpfile}"


# Test for isatty(1) behaviour:
#    cc test.c -o test
#    `tmux new "./test > out"`

# ./test.c:
# 
#    #include <unistd.h>
#    #include <stdio.h>
#
#    main() {
#      if (isatty(1)) {
#        printf("\033\[31mWe are on the terminal, this is a red text\033\[m\n");
#      } else {
#        printf("We are not on the terminal, this is a black text\n");
#      }
#    }

